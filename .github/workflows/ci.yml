
name: CI

on:
  push:
    branches: ["**"]
    paths-ignore:
      - "docs/**"
      - "*.md"
  pull_request:
    branches: ["**"]

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tox:
    name: Tox (lint/format/tests)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install system deps (optional)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential

      - name: Upgrade pip/setuptools/wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Install tox and plugins
        run: |
          pip install tox tox-gh-actions

      # If using a pyproject PEP 517 build, you donâ€™t need this;
      # tox will build/install the package in isolated envs.
      # But this keeps a cache footprint warm and helps dependency caching.
      - name: Pre-install project (editable) for caching
        run: |
          pip install -e .

      # Optional: Cache tox environments to speed up repeated runs.
      # The cache key includes the Python version and a hash of lockfiles & tox.ini.
      - name: Cache tox
        uses: actions/cache@v4
        with:
          path: |
            .tox
          key: tox-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('tox.ini', 'pyproject.toml', 'poetry.lock', 'requirements*.txt') }}
          restore-keys: |
            tox-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Run tox
        env:
          # Make CI mode visible to your code/docs/tools if needed
          CI: "true"
        run: |
          tox

      # Store coverage (if you produce .coverage or HTML reports)
      - name: Upload coverage data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: |
            .coverage*
            htmlcov/**
          if-no-files-found: ignore
